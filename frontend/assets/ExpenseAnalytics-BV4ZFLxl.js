import{j as e}from"./index-BRkigiy4.js";import{r}from"./router-DUq0sin2.js";import{listProperties as K,me as V,listExpenses as Z,createExpense as ee,deleteExpense as te}from"./api-DQwSXtBv.js";import"./vendor-Bzgz95E1.js";import"./icons-ByKMif1I.js";import"./utils-B9HHbEsj.js";const L=["Electricity Bill","Water Bill","Maintenance","Cleaning & Housekeeping","Property Tax","Security Staff Salary","Gardening / Landscaping","Internet / Wi-Fi","Repairs & Renovations","Waste Management","Insurance","Miscellaneous"],ce=()=>{const O=(()=>{try{return JSON.parse(localStorage.getItem("user")||"null")}catch{return null}})(),[N,W]=r.useState(O?.id??null),[g,v]=r.useState([]),[w,h]=r.useState(!1),[D,p]=r.useState(""),[E,q]=r.useState(L[0]),[S,F]=r.useState(""),[A,P]=r.useState(new Date().toISOString().split("T")[0]),[u,_]=r.useState(null),[i,M]=r.useState(""),[c,$]=r.useState(""),[B,G]=r.useState([]),[j,T]=r.useState([]),[d,C]=r.useState(null),y=async()=>{try{const s=(await Z()).data?.data?.expenses||[];v(s),console.log(`üìä Fetched ${s.length} expenses`);const n=s.filter(a=>a.property_id!==null&&a.property_id!==void 0).length,l=s.filter(a=>a.property_id===null||a.property_id===void 0).length;console.log(`   - With property_id: ${n}`),console.log(`   - Without property_id (general): ${l}`)}catch(t){console.error("Error fetching expenses:",t),v([])}};r.useEffect(()=>{y(),Y()},[]);const Y=async()=>{try{const t=await K(),s=t.data?.data?.properties||t.data?.data||[];T(s)}catch(t){console.error("Error fetching properties:",t),T([])}};r.useEffect(()=>{(async()=>{try{const s=(await V())?.data?.data?.admin?.id??null;s!=null&&W(s)}catch{}})()},[]),r.useEffect(()=>{let t=g;d!==null&&(t=t.filter(s=>s.property_id===d)),(i||c)&&(t=t.filter(s=>{const n=new Date(s.created_at),l=i?new Date(i):null,a=c?new Date(c):null;return l&&a?n>=l&&n<=a:l?n>=l:a?n<=a:!0})),G(t)},[g,i,c,d]);const R=async t=>{t.preventDefault(),h(!0),p("");try{const s=parseFloat(S);if(isNaN(s)||s<=0){p("Amount must be a positive number");return}const n={type:E,amount:s,date:A};u!==null&&u>0?(n.property_id=Number(u),console.log(`üìù Creating expense with property_id: ${u}`)):(n.property_id=null,console.log("üìù Creating general expense (no property)")),console.log("üì§ Sending expense data:",n);const l=await ee(n);console.log("‚úÖ Expense created successfully:",l?.data),F(""),P(new Date().toISOString().split("T")[0]),_(null),await y()}catch(s){p(s?.userMessage||s?.message||"Failed to add expense")}finally{h(!1)}},z=async(t,s)=>{const n=s?.category||"Expense",l=s?.amount!=null?Number(s.amount).toFixed(2):"",a=s?.created_at?new Date(s.created_at).toLocaleDateString():"",X=["Confirm delete",n,l?`‚Ç¨${l}`:"",a?`on ${a}`:""].filter(Boolean).join(" ");if(window.confirm(`${X}? This cannot be undone.`)){console.log("[ExpenseAnalytics] Deleting expense ID:",t);try{p(""),h(!0);const o=await te(t);console.log("[ExpenseAnalytics] Delete response:",o),await y(),console.log("[ExpenseAnalytics] Expense deleted and list refreshed")}catch(o){console.error("[ExpenseAnalytics] Delete failed:",o),console.error("[ExpenseAnalytics] Error response:",o?.response);const k=o?.response?.status;let b=o?.response?.data?.error||o?.userMessage||o?.message||"Failed to delete expense";k===404?b="Expense not found or access denied (data isolation)":k===403&&(b="Access denied: this expense belongs to another admin"),p(b),alert(`Delete failed: ${b}`),setTimeout(()=>p(""),5e3);try{await y()}catch{}}finally{h(!1)}}},m=d!==null||i||c?B:g,f=new Date,H=`${f.getFullYear()}-${String(f.getMonth()+1).padStart(2,"0")}`,I=m.filter(t=>{const s=new Date(t.created_at);return`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}`===H}).reduce((t,s)=>t+Number(s.amount||0),0),x={};m.forEach(t=>{const s=t.category||"Miscellaneous";x[s]=(x[s]||0)+Number(t.amount||0)});const J=Object.keys(x).length>0?Object.keys(x).reduce((t,s)=>x[t]>x[s]?t:s):"N/A",Q=new Date(f.getFullYear(),f.getMonth()+1,0).getDate(),U=I/Q;return e.jsxs("div",{className:"space-y-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Tableau de Bord d'Analyse des D√©penses"}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"‚ûï Ajouter une D√©pense"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"S√©lectionnez une propri√©t√© pour isoler les charges par propri√©t√©, ou laissez vide pour une d√©pense g√©n√©rale."}),e.jsxs("form",{onSubmit:R,className:"flex flex-wrap gap-4 items-end",children:[e.jsxs("div",{className:"flex-1 min-w-[200px]",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Type de D√©pense"}),e.jsx("select",{value:E,onChange:t=>q(t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:L.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{className:"flex-1 min-w-[200px]",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["üè† Propri√©t√© ",e.jsx("span",{className:"text-gray-500 text-xs",children:"(Pour isoler les charges)"})]}),e.jsxs("select",{value:u||"",onChange:t=>_(t.target.value?parseInt(t.target.value):null),className:"w-full px-3 py-2 border-2 border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white",children:[e.jsx("option",{value:"",children:"üåê Aucune propri√©t√© (D√©pense G√©n√©rale)"}),j.map(t=>e.jsxs("option",{value:t.id,children:["üè† ",t.title||t.name||`Propri√©t√© ${t.id}`]},t.id))]}),u&&e.jsx("p",{className:"text-xs text-blue-600 mt-1",children:"‚úì Les charges seront isol√©es pour cette propri√©t√© uniquement"})]}),e.jsxs("div",{className:"flex-1 min-w-[150px]",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Montant"}),e.jsx("input",{type:"number",step:"0.01",value:S,onChange:t=>F(t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{className:"flex-1 min-w-[150px]",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date"}),e.jsx("input",{type:"date",value:A,onChange:t=>P(t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsx("button",{type:"submit",disabled:w,className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50",children:w?"Ajout...":"Ajouter D√©pense"})]}),D&&e.jsx("div",{className:"text-red-600 mt-2",children:D})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"üîç Filtres"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 items-end",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["üîç Filtrer par Propri√©t√© ",e.jsx("span",{className:"text-gray-500 text-xs",children:"(Affichage uniquement)"})]}),e.jsxs("select",{value:d||"",onChange:t=>{const s=t.target.value;C(s?parseInt(s):null),console.log(`üîç Display filter changed to property: ${s||"all"}`)},className:"w-full px-3 py-2 border-2 border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white",children:[e.jsx("option",{value:"",children:"Toutes les propri√©t√©s (Afficher toutes les d√©penses)"}),j.map(t=>e.jsxs("option",{value:t.id,children:["üè† ",t.title||t.name||`Propri√©t√© ${t.id}`]},t.id))]}),d&&e.jsx("p",{className:"text-xs text-purple-600 mt-1",children:"‚úì Affichage filtr√© pour cette propri√©t√© uniquement"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date de D√©but"}),e.jsx("input",{type:"date",value:i,onChange:t=>M(t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date de Fin"}),e.jsx("input",{type:"date",value:c,onChange:t=>$(t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>{M(""),$(""),C(null),console.log("üîç Display filters cleared")},className:"px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors",children:"Effacer les Filtres"}),e.jsx("div",{className:"text-sm text-gray-600 flex items-center",children:i||c||d!==null?e.jsxs("span",{className:"bg-purple-100 text-purple-800 px-3 py-2 rounded",children:[m.length," d√©pense(s) affich√©e(s)"]}):e.jsxs("span",{className:"text-gray-500 px-3 py-2",children:["Toutes les ",g.length," d√©penses"]})})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow",children:[e.jsx("div",{className:"text-sm text-gray-500",children:"D√©pense Mensuelle Totale"}),e.jsxs("div",{className:"text-2xl font-semibold",children:["‚Ç¨",I.toFixed(2)]})]}),e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow",children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Type de D√©pense le Plus √âlev√©"}),e.jsx("div",{className:"text-xl font-semibold",children:J})]}),e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow",children:[e.jsx("div",{className:"text-sm text-gray-500",children:"D√©pense Quotidienne Moyenne"}),e.jsxs("div",{className:"text-2xl font-semibold",children:["‚Ç¨",U.toFixed(2)]})]})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"D√©penses"}),m.length===0?e.jsx("div",{className:"text-gray-500",children:"Aucune d√©pense √† afficher"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-600 border-b",children:[e.jsx("th",{className:"py-2 pr-4",children:"Date"}),e.jsx("th",{className:"py-2 pr-4",children:"Type"}),e.jsx("th",{className:"py-2 pr-4",children:"Montant"}),e.jsx("th",{className:"py-2 pr-4",children:"Mois"}),e.jsx("th",{className:"py-2 pr-4",children:"Propri√©t√©"}),e.jsx("th",{className:"py-2",children:"Action"})]})}),e.jsx("tbody",{children:m.map(t=>{const s=t.property_id?j.find(l=>l.id===t.property_id):null,n=s?s.title||s.name||`Propri√©t√© ${t.property_id}`:"G√©n√©ral";return e.jsxs("tr",{className:"border-b last:border-0",children:[e.jsx("td",{className:"py-2 pr-4",children:new Date(t.created_at).toLocaleDateString()}),e.jsx("td",{className:"py-2 pr-4",children:t.category}),e.jsxs("td",{className:"py-2 pr-4",children:["‚Ç¨",Number(t.amount||0).toFixed(2)]}),e.jsx("td",{className:"py-2 pr-4",children:t.month}),e.jsx("td",{className:"py-2 pr-4",children:e.jsx("span",{className:`px-2 py-1 rounded text-xs ${t.property_id?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-600"}`,children:t.property_id?`üè† ${n}`:"üåê G√©n√©ral"})}),e.jsx("td",{className:"py-2",children:N!=null&&t.admin_id===N?e.jsx("button",{onClick:()=>z(t.id,t),className:"px-3 py-1 rounded bg-red-600 text-white hover:bg-red-700",children:"Supprimer"}):e.jsx("span",{className:"text-xs text-gray-500",children:"Pas le v√¥tre"})})]},t.id)})})]})})]})]})};export{ce as default};
