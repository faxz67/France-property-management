import{j as e}from"./index-rAghrxu1.js";import{r as a}from"./router-DUq0sin2.js";import{me as le,listExpenses as re,createExpense as ie,deleteExpense as de}from"./api-XfUXylTc.js";import{R as v,P as F,a as M,C,T as w,L as D,B as oe,X as ce,Y as ue,b as me}from"./charts-DdKZH6bc.js";import"./vendor-Bzgz95E1.js";import"./icons-B-WyEUkg.js";import"./utils-B9HHbEsj.js";const G=["Electricity Bill","Water Bill","Maintenance","Cleaning & Housekeeping","Property Tax","Security Staff Salary","Gardening / Landscaping","Internet / Wi-Fi","Repairs & Renovations","Waste Management","Insurance","Miscellaneous"],p=["#0088FE","#00C49F","#FFBB28","#FF8042","#8884D8","#82CA9D","#FFC658","#FF6361","#BC5090","#58508D","#003F5C","#665191"],Ne=()=>{const H=(()=>{try{return JSON.parse(localStorage.getItem("user")||"null")}catch{return null}})(),[T,J]=a.useState(H?.id??null),[m,k]=a.useState([]),[$,g]=a.useState(!1),[O,x]=a.useState(""),[P,z]=a.useState(G[0]),[R,B]=a.useState(""),[I,K]=a.useState(new Date().toISOString().split("T")[0]),[i,_]=a.useState(""),[d,L]=a.useState(""),[Y,U]=a.useState([]),y=async()=>{try{const s=await re();k(s.data?.data?.expenses||[])}catch(s){console.error("Error fetching expenses:",s),k([])}};a.useEffect(()=>{y()},[]),a.useEffect(()=>{(async()=>{try{const t=(await le())?.data?.data?.admin?.id??null;t!=null&&J(t)}catch{}})()},[]),a.useEffect(()=>{if(!i&&!d){U(m);return}const s=m.filter(t=>{const n=new Date(t.created_at),c=i?new Date(i):null,u=d?new Date(d):null;return c&&u?n>=c&&n<=u:c?n>=c:u?n<=u:!0});U(s)},[m,i,d]);const V=async s=>{s.preventDefault(),g(!0),x("");try{const t=parseFloat(R);if(isNaN(t)||t<=0){x("Amount must be a positive number");return}await ie({type:P,amount:t,date:I}),B(""),K(new Date().toISOString().split("T")[0]),await y()}catch(t){x(t?.userMessage||t?.message||"Failed to add expense")}finally{g(!1)}},Z=async(s,t)=>{const n=t?.category||"Expense",c=t?.amount!=null?Number(t.amount).toFixed(2):"",u=t?.created_at?new Date(t.created_at).toLocaleDateString():"",ne=["Confirm delete",n,c?`‚Ç¨${c}`:"",u?`on ${u}`:""].filter(Boolean).join(" ");if(window.confirm(`${ne}? This cannot be undone.`)){console.log("[ExpenseAnalytics] Deleting expense ID:",s);try{x(""),g(!0);const r=await de(s);console.log("[ExpenseAnalytics] Delete response:",r),await y(),console.log("[ExpenseAnalytics] Expense deleted and list refreshed")}catch(r){console.error("[ExpenseAnalytics] Delete failed:",r),console.error("[ExpenseAnalytics] Error response:",r?.response);const q=r?.response?.status;let N=r?.response?.data?.error||r?.userMessage||r?.message||"Failed to delete expense";q===404?N="Expense not found or access denied (data isolation)":q===403&&(N="Access denied: this expense belongs to another admin"),x(N),alert(`Delete failed: ${N}`),setTimeout(()=>x(""),5e3);try{await y()}catch{}}finally{g(!1)}}},o=Y.length>0||i||d?Y:m,b=new Date,ee=`${b.getFullYear()}-${String(b.getMonth()+1).padStart(2,"0")}`,W=o.filter(s=>{const t=new Date(s.created_at);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`===ee}),X=W.reduce((s,t)=>s+Number(t.amount||0),0),l={};o.forEach(s=>{const t=s.category||"Miscellaneous";l[t]=(l[t]||0)+Number(s.amount||0)});const se=Object.keys(l).length>0?Object.keys(l).reduce((s,t)=>l[s]>l[t]?s:t):"N/A",te=new Date(b.getFullYear(),b.getMonth()+1,0).getDate(),ae=X/te,E=Object.keys(l).map(s=>({name:s,value:l[s]})),j={};o.forEach(s=>{const t=s.month||"Unknown";j[t]=(j[t]||0)+Number(s.amount||0)});const S=Object.keys(j).sort().slice(-6).map(s=>({name:s,value:j[s]})),h={"Under ‚Ç¨50":0,"‚Ç¨50 - ‚Ç¨100":0,"‚Ç¨100 - ‚Ç¨500":0,"Over ‚Ç¨500":0};o.forEach(s=>{const t=Number(s.amount||0);t<50?h["Under ‚Ç¨50"]++:t<100?h["‚Ç¨50 - ‚Ç¨100"]++:t<500?h["‚Ç¨100 - ‚Ç¨500"]++:h["Over ‚Ç¨500"]++});const A=Object.keys(h).map(s=>({name:s,value:h[s]})).filter(s=>s.value>0),f={};W.forEach(s=>{const t=new Date(s.created_at),n=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;f[n]=(f[n]||0)+Number(s.amount||0)});const Q=Object.keys(f).sort().map(s=>({date:s,amount:f[s]}));return e.jsxs("div",{className:"space-y-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Tableau de Bord d'Analyse des D√©penses"}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Ajouter une D√©pense"}),e.jsxs("form",{onSubmit:V,className:"flex flex-wrap gap-4 items-end",children:[e.jsxs("div",{className:"flex-1 min-w-[200px]",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Type de D√©pense"}),e.jsx("select",{value:P,onChange:s=>z(s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:G.map(s=>e.jsx("option",{value:s,children:s},s))})]}),e.jsxs("div",{className:"flex-1 min-w-[150px]",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Montant"}),e.jsx("input",{type:"number",step:"0.01",value:R,onChange:s=>B(s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{className:"flex-1 min-w-[150px]",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date"}),e.jsx("input",{type:"date",value:I,onChange:s=>K(s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsx("button",{type:"submit",disabled:$,className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50",children:$?"Ajout...":"Ajouter D√©pense"})]}),O&&e.jsx("div",{className:"text-red-600 mt-2",children:O})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"üìÖ Filtrer par Plage de Dates"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date de D√©but"}),e.jsx("input",{type:"date",value:i,onChange:s=>_(s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date de Fin"}),e.jsx("input",{type:"date",value:d,onChange:s=>L(s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>{_(""),L("")},className:"px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors",children:"Effacer le Filtre"}),e.jsx("div",{className:"text-sm text-gray-600 flex items-center",children:i||d?e.jsxs("span",{className:"bg-blue-100 text-blue-800 px-3 py-2 rounded",children:["Affichage de ",o.length," sur ",m.length," d√©penses"]}):e.jsxs("span",{className:"text-gray-500 px-3 py-2",children:["Toutes les ",m.length," d√©penses"]})})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow",children:[e.jsx("div",{className:"text-sm text-gray-500",children:"D√©pense Mensuelle Totale"}),e.jsxs("div",{className:"text-2xl font-semibold",children:["‚Ç¨",X.toFixed(2)]})]}),e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow",children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Type de D√©pense le Plus √âlev√©"}),e.jsx("div",{className:"text-xl font-semibold",children:se})]}),e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow",children:[e.jsx("div",{className:"text-sm text-gray-500",children:"D√©pense Quotidienne Moyenne"}),e.jsxs("div",{className:"text-2xl font-semibold",children:["‚Ç¨",ae.toFixed(2)]})]})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"D√©penses"}),o.length===0?e.jsx("div",{className:"text-gray-500",children:"Aucune d√©pense √† afficher"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-600 border-b",children:[e.jsx("th",{className:"py-2 pr-4",children:"Date"}),e.jsx("th",{className:"py-2 pr-4",children:"Type"}),e.jsx("th",{className:"py-2 pr-4",children:"Montant"}),e.jsx("th",{className:"py-2 pr-4",children:"Mois"}),e.jsx("th",{className:"py-2",children:"Action"})]})}),e.jsx("tbody",{children:o.map(s=>e.jsxs("tr",{className:"border-b last:border-0",children:[e.jsx("td",{className:"py-2 pr-4",children:new Date(s.created_at).toLocaleDateString()}),e.jsx("td",{className:"py-2 pr-4",children:s.category}),e.jsxs("td",{className:"py-2 pr-4",children:["‚Ç¨",Number(s.amount||0).toFixed(2)]}),e.jsx("td",{className:"py-2 pr-4",children:s.month}),e.jsx("td",{className:"py-2",children:T!=null&&s.admin_id===T?e.jsx("button",{onClick:()=>Z(s.id,s),className:"px-3 py-1 rounded bg-red-600 text-white hover:bg-red-700",children:"Supprimer"}):e.jsx("span",{className:"text-xs text-gray-500",children:"Pas le v√¥tre"})})]},s.id))})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"üí∞ R√©partition des D√©penses par Type"}),E.length>0?e.jsx(v,{width:"100%",height:300,children:e.jsxs(F,{children:[e.jsx(M,{data:E,dataKey:"value",nameKey:"name",cx:"50%",cy:"50%",outerRadius:80,label:!0,children:E.map((s,t)=>e.jsx(C,{fill:p[t%p.length]},`cell-${t}`))}),e.jsx(w,{}),e.jsx(D,{})]})}):e.jsx("div",{className:"text-gray-500 text-center py-12",children:"Aucune donn√©e de d√©pense encore"})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"üìÖ Distribution Mensuelle (6 Derniers Mois)"}),S.length>0?e.jsx(v,{width:"100%",height:300,children:e.jsxs(F,{children:[e.jsx(M,{data:S,dataKey:"value",nameKey:"name",cx:"50%",cy:"50%",outerRadius:80,label:!0,children:S.map((s,t)=>e.jsx(C,{fill:p[t%p.length]},`cell-${t}`))}),e.jsx(w,{}),e.jsx(D,{})]})}):e.jsx("div",{className:"text-gray-500 text-center py-12",children:"Aucune donn√©e mensuelle disponible"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"üìä Nombre de D√©penses par Plage de Montant"}),A.length>0?e.jsx(v,{width:"100%",height:300,children:e.jsxs(F,{children:[e.jsx(M,{data:A,dataKey:"value",nameKey:"name",cx:"50%",cy:"50%",outerRadius:80,label:!0,children:A.map((s,t)=>e.jsx(C,{fill:p[t%p.length]},`cell-${t}`))}),e.jsx(w,{}),e.jsx(D,{})]})}):e.jsx("div",{className:"text-gray-500 text-center py-12",children:"Aucune donn√©e de plage disponible"})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"üìà Tendance des D√©penses Quotidiennes (Mois Actuel)"}),Q.length>0?e.jsx(v,{width:"100%",height:300,children:e.jsxs(oe,{data:Q,children:[e.jsx(ce,{dataKey:"date"}),e.jsx(ue,{}),e.jsx(w,{}),e.jsx(D,{}),e.jsx(me,{dataKey:"amount",fill:"#8884d8"})]})}):e.jsx("div",{className:"text-gray-500 text-center py-12",children:"Aucune donn√©e de d√©pense pour ce mois"})]})]})]})};export{Ne as default};
